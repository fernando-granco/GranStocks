generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String          @id @default(uuid())
  email        String          @unique
  passwordHash String
  role         String          @default("USER") // ENUM(USER, ADMIN)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  trackedAssets TrackedAsset[]
  llmConfigs    UserLLMConfig[]
  narratives    AiNarrative[]
}

model Asset {
  symbol      String   @id
  type        String   @default("STOCK") // Enum(STOCK) represented as string in SQLite
  displayName String
  exchange    String?
  currency    String   @default("USD")
  isActive    Boolean  @default(true)
}

model TrackedAsset {
  id        String   @id @default(uuid())
  userId    String
  symbol    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, symbol])
}

model CachedResponse {
  cacheKey    String   @id
  payloadJson String
  ts          DateTime @default(now())
  ttlSeconds  Int
  isStale     Boolean  @default(false)
  source      String   // ENUM(FINNHUB)
}

model IndicatorSnapshot {
  id             String   @id @default(uuid())
  symbol         String
  date           String   // YYYY-MM-DD
  indicatorsJson String
  createdAt      DateTime @default(now())

  @@unique([symbol, date])
}

model PredictionSnapshot {
  id                 String   @id @default(uuid())
  symbol             String
  date               String   // YYYY-MM-DD
  horizonDays        Int      // 1, 5, 20
  predictedReturnPct Float
  predictedPrice     Float
  confidence         Float    // 0-1
  featuresJson       String
  explanationText    String
  createdAt          DateTime @default(now())

  @@unique([symbol, date, horizonDays])
}

model UserLLMConfig {
  id               String   @id @default(uuid())
  userId           String
  name             String   // e.g. "ChatGPT"
  provider         String   // OPENAI, GOOGLE, ANTHROPIC, XAI, OPENROUTER, DEEPSEEK, PERPLEXITY, OPENAI_COMPAT
  model            String
  encryptedApiKey  String
  keyLast4         String
  baseUrl          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id])
  narratives       AiNarrative[]
}

model AiNarrative {
  id            String   @id @default(uuid())
  userId        String
  assetType     String   @default("STOCK") // STOCK or CRYPTO
  symbol        String?  // null = daily summary
  dateHour      String
  role          String   @default("CONSENSUS")
  llmConfigId   String
  contentText   String
  providerUsed  String
  modelUsed     String
  createdAt     DateTime @default(now())

  user          User           @relation(fields: [userId], references: [id])
  llmConfig     UserLLMConfig  @relation(fields: [llmConfigId], references: [id])
}

model ScreenerSnapshot {
  id            String   @id @default(uuid())
  dateHour      String   // YYYY-MM-DDTHH:00
  universeType  String   // STOCK | CRYPTO
  universeName  String
  symbol        String
  assetType     String   @default("STOCK")
  score         Float
  metricsJson   String
  riskFlagsJson String   @default("{}")
  price         Float    @default(0)
  source        String   @default("UNKNOWN")
  ts            DateTime @default(now())
  createdAt     DateTime @default(now())

  @@unique([dateHour, universeType, universeName, symbol])
}

model JobState {
  id           String   @id @default(uuid())
  universeType String   // STOCK | CRYPTO
  universeName String
  status       String   // PENDING, RUNNING, COMPLETED, FAILED
  cursorIndex  Int      @default(0)
  total        Int
  lastRunAt    DateTime @default(now())
  lastError    String?
  updatedAt    DateTime @updatedAt

  @@unique([universeType, universeName])
}

model AnalysisSnapshot {
  id            String   @id @default(uuid())
  dateHour      String   // YYYY-MM-DDTHH:00
  assetType     String   // STOCK | CRYPTO
  symbol        String
  role          String   // TECHNICAL, FUNDAMENTAL, SENTIMENT, BULL, BEAR, RISK, CONSENSUS
  payloadJson   String
  createdAt     DateTime @default(now())

  @@unique([dateHour, assetType, symbol, role])
}
